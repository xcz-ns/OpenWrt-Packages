name: è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸
run-name: è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ï¼ˆ${{ github.event_name }} - ${{ github.run_number }}ï¼‰

on:
  schedule:
    - cron: '0 4 * * *'  # UTC 4ç‚¹ï¼Œå³åŒ—äº¬æ—¶é—´12ç‚¹
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/sync.yml'

jobs:
  sync:
    name: åŒæ­¥åˆ° ${{ matrix.branch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: ['18.06', '24.10']
        include:
          - branch: '18.06'
            repos: |
              {
                "luci-app-argon-config": "https://github.com/jerrykuku/luci-app-argon-config 18.06",
                "luci-theme-argon": "https://github.com/jerrykuku/luci-theme-argon 18.06",
                "luci-theme-design": "https://github.com/0x676e67/luci-theme-design",
                "luci-app-design-config": "https://github.com/0x676e67/luci-app-design-config",
                "luci-theme-neobird": "https://github.com/thinktip/luci-theme-neobird",
                "luci-app-lucky": "https://github.com/gdy666/luci-app-lucky",
                "luci-app-filebrowser": "https://github.com/wangqn/luci-app-filebrowser",
                "luci-app-poweroff": "https://github.com/esirplayground/luci-app-poweroff",
                "luci-app-store": "https://github.com/db-one/dbone-packages 18.06",
                "luci-app-openclash": "https://github.com/vernesong/OpenClash",
                "luci-app-oaf": "https://github.com/db-one/dbone-packages 18.06",
                "luci-app-shutdown": "https://github.com/db-one/dbone-packages 18.06",
                "luci-lib-xterm": "https://github.com/db-one/dbone-packages 18.06",
                "taskd": "https://github.com/db-one/dbone-packages 18.06",
                "gowebdav": "https://github.com/linkease/istore-packages",
                "luci-app-gowebdav": "https://github.com/linkease/istore-packages",
                "luci-app-unishare": "https://github.com/linkease/nas-packages-luci",
                "unishare": "https://github.com/linkease/nas-packages",
                "webdav2": "https://github.com/linkease/nas-packages"
              }
            subdirs: |
              {
                "luci-app-lucky": "luci-app-lucky",
                "luci-app-store": "luci-app-store",
                "luci-app-openclash": "luci-app-openclash",
                "luci-lib-xterm": "luci-lib-xterm",
                "taskd": "taskd",
                "luci-app-shutdown": "luci-app-shutdown", 
                "luci-app-oaf": "luci-app-oaf",
                "gowebdav": "gowebdav",
                "luci-app-gowebdav": "luci-app-gowebdav",
                "luci-app-unishare": "luci/luci-app-unishare",
                "unishare": "network/services/unishare",
                "webdav2": "network/services/webdav2"
              }
          - branch: '24.10'
            repos: |
              {
                "luci-app-argon-config": "https://github.com/jerrykuku/luci-app-argon-config",
                "luci-theme-argon": "https://github.com/jerrykuku/luci-theme-argon",
                "luci-theme-neobird": "https://github.com/thinktip/luci-theme-neobird",
                "luci-app-lucky": "https://github.com/gdy666/luci-app-lucky",
                "luci-app-filebrowser": "https://github.com/Lienol/openwrt-package",
                "luci-app-poweroff": "https://github.com/esirplayground/luci-app-poweroff",
                "luci-app-store": "https://github.com/db-one/dbone-packages 23.05",
                "luci-app-openclash": "https://github.com/vernesong/OpenClash",
                "luci-app-oaf": "https://github.com/db-one/dbone-packages 23.05",
                "luci-lib-taskd": "https://github.com/db-one/dbone-packages 23.05",
                "luci-lib-xterm": "https://github.com/db-one/dbone-packages 23.05",
                "taskd": "https://github.com/db-one/dbone-packages 23.05",
                "gowebdav": "https://github.com/linkease/istore-packages",
                "luci-app-gowebdav": "https://github.com/linkease/istore-packages",
                "luci-app-unishare": "https://github.com/linkease/nas-packages-luci",
                "unishare": "https://github.com/linkease/nas-packages",
                "webdav2": "https://github.com/linkease/nas-packages"
              }
            subdirs: |
              {
                "luci-app-lucky": "luci-app-lucky",
                "luci-app-store": "luci-app-store",
                "luci-app-openclash": "luci-app-openclash",
                "luci-app-filebrowser": "luci-app-filebrowser",
                "luci-lib-taskd": "luci-lib-taskd",
                "luci-lib-xterm": "luci-lib-xterm",
                "taskd": "taskd",
                "gowebdav": "gowebdav", 
                "luci-app-oaf": "luci-app-oaf",
                "luci-app-gowebdav": "luci-app-gowebdav",
                "luci-app-unishare": "luci/luci-app-unishare",
                "unishare": "network/services/unishare",
                "webdav2": "network/services/webdav2"
              }
    env:
      TZ: Asia/Shanghai
    steps:
      - name: æ£€å‡º ${{ matrix.branch }} åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: è®¾ç½® Git ç”¨æˆ·å
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: æ£€æŸ¥å¹¶å®‰è£… jq
        run: |
          if ! command -v jq &> /dev/null; then
            echo "jq æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
            sudo apt-get update
            sudo apt-get install -y jq
          else
            echo "jq å·²å®‰è£…"
          fi

      - name: å¢é‡åŒæ­¥ä»“åº“
        run: |
          REPOS_JSON='${{ matrix.repos }}'
          SUBDIRS_JSON='${{ matrix.subdirs }}'
          SYNC_RECORD=".sync-record-${{ matrix.branch }}"
          TEMP_RECORD="${SYNC_RECORD}.tmp"

          declare -A repos subdirs last_commits
          force_pull_all=false

          while IFS="=" read -r key value; do repos["$key"]="$value"; done < <(jq -r 'to_entries | .[] | "\(.key)=\(.value)"' <<< "$REPOS_JSON")
          while IFS="=" read -r key value; do subdirs["$key"]="$value"; done < <(jq -r 'to_entries | .[] | "\(.key)=\(.value)"' <<< "$SUBDIRS_JSON")

          if [ -f "$SYNC_RECORD" ]; then
            if [ ! -s "$SYNC_RECORD" ]; then
              echo "âš ï¸ åŒæ­¥è®°å½•ä¸ºç©ºï¼Œå¼ºåˆ¶æ‹‰å–æ‰€æœ‰ä»“åº“"
              force_pull_all=true
            else
              while read -r repo commit; do
                last_commits["$repo"]=$commit
              done < "$SYNC_RECORD"
            fi
          else
            echo "âš ï¸ åŒæ­¥è®°å½•ä¸å­˜åœ¨ï¼Œå¼ºåˆ¶æ‹‰å–æ‰€æœ‰ä»“åº“"
            force_pull_all=true
          fi

          mkdir -p sync_temp && cd sync_temp
          changes_detected=false
          > "../$TEMP_RECORD"

          for name in "${!repos[@]}"; do
            (
              echo "ğŸ” æ­£åœ¨å¤„ç†ä»“åº“: $name"
              entry="${repos[$name]}"
              url=$(echo "$entry" | awk '{print $1}')
              branch=$(echo "$entry" | awk '{print $2}')
              remote_commit=$(git ls-remote "$url" "refs/heads/${branch:-HEAD}" | awk '{print $1}')
              [ -z "$remote_commit" ] && echo "âŒ è·å–è¿œç¨‹æäº¤å¤±è´¥: $name" && exit 0

              local_commit="${last_commits[$name]:-}"
              if [ "$remote_commit" == "$local_commit" ] && [ "$force_pull_all" != true ]; then
                echo "âœ… $name æ— å˜åŒ–ï¼Œè·³è¿‡"
              else
                echo "ğŸ”„ $name æœ‰æ›´æ–°ï¼ˆ${local_commit:0:7:-æ— -} â†’ ${remote_commit:0:7}ï¼‰"
                changes_detected=true
                rm -rf "../$name"
                clone_dir="${name}-temp"
                for i in {1..3}; do
                  if [ -n "$branch" ]; then
                    git clone -q --depth=1 -b "$branch" "$url" "$clone_dir" && break
                  else
                    git clone -q --depth=1 "$url" "$clone_dir" && break
                  fi
                  sleep 2 && rm -rf "$clone_dir"
                done

                [ ! -d "$clone_dir" ] && echo "âŒ å…‹éš†å¤±è´¥: $name" && exit 0

                if [[ -n "${subdirs[$name]}" ]] && [ -d "$clone_dir/${subdirs[$name]}" ]; then
                  mv "$clone_dir/${subdirs[$name]}" "${clone_dir}-content"
                  rm -rf "$clone_dir"
                  mv "${clone_dir}-content" "$clone_dir"
                fi

                rm -rf "$clone_dir/.git"
                mv "$clone_dir" "../$name"
                echo "âœ… $name æ›´æ–°å®Œæˆ"
              fi

              echo "$name $remote_commit" >> "../$TEMP_RECORD"
            ) || echo "âš ï¸ $name å¤„ç†å¤±è´¥"
          done

          cd ..
          mv "$TEMP_RECORD" "$SYNC_RECORD"
          echo "ğŸ“¦ åŒæ­¥è®°å½•:"
          cat "$SYNC_RECORD"

      - name: æ£€æµ‹æ”¹åŠ¨å¹¶æäº¤
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            time=$(date '+%Y-%m-%d %H-%M-%S')
            git add .
            git commit -m "ğŸˆåŒæ­¥æ—¶é—´ $timeğŸš€"
            git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
            git push origin ${{ matrix.branch }}
            echo "âœ… å·²æäº¤æ¨é€"
          else
            echo "ğŸŸ¢ æ— æ”¹åŠ¨ï¼Œæ— éœ€æäº¤"
          fi

  clean_runs:
    name: æ¸…ç†å†å²è¿è¡Œè®°å½•
    runs-on: ubuntu-latest
    needs: sync
    steps:
      - name: æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 0
          keep_minimum_runs: 0