name: 每日同步上游仓库到 18.06

on:
  schedule:
    - cron: '0 4 * * *'  # UTC 4点，即北京时间12点
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: 检出当前仓库（18.06 分支）
        uses: actions/checkout@v4
        with:
          ref: 18.06
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: 配置 Git 用户信息
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: 同步上游仓库（增量更新）
        run: |
          mkdir sync
          cd sync

          declare -A repos=(
            ["luci-app-argon-config"]="https://github.com/jerrykuku/luci-app-argon-config 18.06"
            ["luci-theme-argon"]="https://github.com/jerrykuku/luci-theme-argon 18.06"
            ["luci-theme-design"]="https://github.com/0x676e67/luci-theme-design"
            ["luci-app-design-config"]="https://github.com/0x676e67/luci-app-design-config"
            ["luci-theme-neobird"]="https://github.com/thinktip/luci-theme-neobird.git"
            ["luci-app-lucky"]="https://github.com/gdy666/luci-app-lucky.git"
            ["luci-app-filebrowser"]="https://github.com/xiaozhuai/luci-app-filebrowser 18.06"
            ["luci-app-GoWebDav"]="https://github.com/ToDesk/luci-app-GoWebDav.git"
            ["luci-app-poweroff"]="https://github.com/esirplayground/luci-app-poweroff"
            ["luci-app-store"]="https://github.com/db-one/dbone-packages 18.06"
          )

          for name in "${!repos[@]}"; do
            entry=(${repos[$name]})
            url=${entry[0]}
            branch=${entry[1]:-}  # 默认空，表示不指定分支

            echo "处理仓库 $name，URL: $url，分支: ${branch:-默认分支}"

            if [ -d "$name" ]; then
              cd "$name"
              if [ -n "$branch" ]; then
                git fetch "$url" "$branch" --depth=1
                remote_commit=$(git rev-parse FETCH_HEAD)
              else
                git fetch "$url" --depth=1
                remote_commit=$(git rev-parse FETCH_HEAD)
              fi
              local_commit=$(git rev-parse HEAD)

              if [ "$remote_commit" = "$local_commit" ]; then
                echo "$name 无变化，跳过更新"
                cd ..
                continue
              else
                echo "$name 有更新，开始同步"
                git reset --hard "$remote_commit"
                cd ..
              fi
            else
              echo "$name 本地不存在，克隆仓库"
              if [ -n "$branch" ]; then
                git clone --depth=1 -b "$branch" "$url" "$name"
              else
                git clone --depth=1 "$url" "$name"
              fi
            fi

            # 删除.git防止提交错误
            rm -rf "$name/.git"

            # 处理特殊目录结构
            if [[ "$name" == "luci-app-store" ]]; then
              mv "$name/luci-app-store" "$name-temp"
              rm -rf "$name"
              mv "$name-temp" "$name"
            fi
          done

          # 拷贝所有同步内容到主目录
          cp -a ./sync/* ../
          cd ..
          rm -rf sync

      - name: 检查变更并提交推送
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            time=$(date '+%Y年%m月%d日 %H时%M分%S秒')
            git add .
            git commit -m "更新时间：$time"
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            git push
          else
            echo "无变化，无需提交"
          fi

      - name: 清理历史 Workflow 运行记录
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 0
          keep_minimum_runs: 0
