name: è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸
run-name: è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ï¼ˆ${{ github.event_name }} - ${{ github.run_number }})
on:
  schedule:
    - cron: '0 4 * * *'  # UTC 4ç‚¹ï¼Œå³åŒ—äº¬æ—¶é—´12ç‚¹
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/sync.yml'

jobs:
  sync:
    name: åŒæ­¥åˆ° ${{ matrix.branch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: ['18.06', '24.10']
        include:
          - branch: '18.06'
            repos: |
              {
                "luci-app-argon-config": "https://github.com/jerrykuku/luci-app-argon-config  18.06",
                "luci-theme-argon": "https://github.com/jerrykuku/luci-theme-argon  18.06",
                "luci-theme-design": "https://github.com/0x676e67/luci-theme-design ",
                "luci-app-design-config": "https://github.com/0x676e67/luci-app-design-config ",
                "luci-theme-neobird": "https://github.com/thinktip/luci-theme-neobird ",
                "luci-app-lucky": "https://github.com/gdy666/luci-app-lucky ",
                "luci-app-filebrowser": "https://github.com/wangqn/luci-app-filebrowser ",
                "luci-app-poweroff": "https://github.com/esirplayground/luci-app-poweroff ",
                "luci-app-store": "https://github.com/db-one/dbone-packages  18.06",
                "luci-app-openclash": "https://github.com/vernesong/OpenClash ",
                "luci-app-oaf": "https://github.com/db-one/dbone-packages  18.06",
                "luci-app-shutdown": "https://github.com/db-one/dbone-packages  18.06",
                "luci-lib-xterm": "https://github.com/db-one/dbone-packages  18.06",
                "taskd": "https://github.com/db-one/dbone-packages  18.06",
                "gowebdav": "https://github.com/linkease/istore-packages ",
                "luci-app-gowebdav": "https://github.com/linkease/istore-packages ",
                "luci-app-unishare": "https://github.com/linkease/nas-packages-luci ",
                "unishare": "https://github.com/linkease/nas-packages ",
                "webdav2": "https://github.com/linkease/nas-packages "
              }
            subdirs: |
              {
                "luci-app-lucky": "luci-app-lucky",
                "luci-app-store": "luci-app-store",
                "luci-app-openclash": "luci-app-openclash",
                "luci-lib-xterm": "luci-lib-xterm",
                "taskd": "taskd",
                "luci-app-shutdown": "luci-app-shutdown", 
                "luci-app-oaf": "luci-app-oaf",
                "gowebdav": "gowebdav",
                "luci-app-gowebdav": "luci-app-gowebdav",
                "luci-app-unishare": "luci-app-unishare",
                "unishare": "network/services/unishare",
                "webdav2": "network/services/webdav2"
              }
          - branch: '24.10'
            repos: |
              {
                "luci-app-argon-config": "https://github.com/jerrykuku/luci-app-argon-config ",
                "luci-theme-argon": "https://github.com/jerrykuku/luci-theme-argon ",
                "luci-theme-neobird": "https://github.com/thinktip/luci-theme-neobird ",
                "luci-app-lucky": "https://github.com/gdy666/luci-app-lucky ",
                "luci-app-filebrowser": "https://github.com/Lienol/openwrt-package ",
                "luci-app-poweroff": "https://github.com/esirplayground/luci-app-poweroff ",
                "luci-app-store": "https://github.com/db-one/dbone-packages  23.05",
                "luci-app-openclash": "https://github.com/vernesong/OpenClash ",
                "luci-app-oaf": "https://github.com/db-one/dbone-packages  23.05",
                "luci-lib-taskd": "https://github.com/db-one/dbone-packages  23.05",
                "luci-lib-xterm": "https://github.com/db-one/dbone-packages  23.05",
                "taskd": "https://github.com/db-one/dbone-packages  23.05",
                "gowebdav": "https://github.com/linkease/istore-packages ",
                "luci-app-gowebdav": "https://github.com/linkease/istore-packages ",
                "luci-app-unishare": "https://github.com/linkease/nas-packages-luci ",
                "unishare": "network/services/unishare",
                "webdav2": "network/services/webdav2"
              }
            subdirs: |
              {
                "luci-app-lucky": "luci-app-lucky",
                "luci-app-store": "luci-app-store",
                "luci-app-openclash": "luci-app-openclash",
                "luci-app-filebrowser": "luci-app-filebrowser",
                "luci-lib-taskd": "luci-lib-taskd",
                "luci-lib-xterm": "luci-lib-xterm",
                "taskd": "taskd",
                "gowebdav": "gowebdav", 
                "luci-app-oaf": "luci-app-oaf",
                "luci-app-gowebdav": "luci-app-gowebdav",
                "luci-app-unishare": "luci/luci-app-unishare",
                "unishare": "network/services/unishare",
                "webdav2": "network/services/webdav2"
              }
    env:
      TZ: Asia/Shanghai
    steps:
      - name: æ£€å‡º ${{ matrix.branch }} åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: è®¾ç½® Git ç”¨æˆ·å
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: æ£€æŸ¥å¹¶å®‰è£… jq
        run: |
          if ! command -v jq &> /dev/null; then
            echo "jq æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
            sudo apt-get update
            sudo apt-get install -y jq
          else
            echo "jq å·²å®‰è£…"
          fi

      - name: åŠ è½½åŒæ­¥è®°å½•
        run: |
          SYNC_RECORD=".sync-record-${{ matrix.branch }}"
          if [ -f "$SYNC_RECORD" ]; then
            if [ ! -s "$SYNC_RECORD" ]; then
              echo "âš ï¸ åŒæ­¥è®°å½•æ–‡ä»¶ä¸ºç©ºï¼Œå°†å¼ºåˆ¶æ›´æ–°æ‰€æœ‰ä»“åº“"
              > "$SYNC_RECORD"
            else
              echo "âœ… è¯»å–å·²æœ‰åŒæ­¥è®°å½•: $SYNC_RECORD"
            fi
          else
            echo "ğŸ†• åˆ›å»ºæ–°åŒæ­¥è®°å½•æ–‡ä»¶: $SYNC_RECORD"
            touch "$SYNC_RECORD"
          fi

      - name: å¢é‡åŒæ­¥ä»“åº“
        run: |
          REPOS_JSON='${{ matrix.repos }}'
          SUBDIRS_JSON='${{ matrix.subdirs }}'
          SYNC_RECORD=".sync-record-${{ matrix.branch }}"
          TEMP_RECORD="${SYNC_RECORD}.tmp"

          declare -A repos
          while IFS="=" read -r key value; do
            repos["$key"]="$value"
          done < <(jq -r 'to_entries | .[] | "\(.key)=\(.value)"' <<< "$REPOS_JSON")

          declare -A subdirs
          while IFS="=" read -r key value; do
            subdirs["$key"]="$value"
          done < <(jq -r 'to_entries | .[] | "\(.key)=\(.value)"' <<< "$SUBDIRS_JSON")

          declare -A last_commits
          if [ -f "$SYNC_RECORD" ]; then
            while read -r repo commit; do
              last_commits["$repo"]=$commit
            done < "$SYNC_RECORD"
          fi

          mkdir -p sync_temp
          cd sync_temp
          changes_detected=false
          > "../$TEMP_RECORD"

          for name in "${!repos[@]}"; do
            (
              echo -e "\nğŸ” å¼€å§‹å¤„ç†ä»“åº“: \033[36m$name\033[0m"
              entry="${repos[$name]}"
              url=$(echo "$entry" | awk '{print $1}')
              branch=$(echo "$entry" | awk '{print $2}')
              echo "   URL: $url"
              echo "   åˆ†æ”¯: ${branch:-é»˜è®¤åˆ†æ”¯}"

              if [ -n "$branch" ]; then
                remote_commit=$(git ls-remote "$url" "refs/heads/$branch" | awk '{print $1}')
              else
                remote_commit=$(git ls-remote "$url" HEAD | awk '{print $1}')
              fi

              if [ -z "$remote_commit" ]; then
                echo -e "\033[31mâŒ æ— æ³•è·å–è¿œç¨‹ä»“åº“æœ€æ–°æäº¤ï¼Œè·³è¿‡ $name\033[0m"
                exit 0
              fi

              local_commit="${last_commits[$name]:-}"
              if [ "$remote_commit" == "$local_commit" ]; then
                echo -e "\033[32mâœ… $name æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°\033[0m"
              else
                echo -e "\033[33mğŸ”„ $name æœ‰æ›´æ–°ï¼ˆæ—§: ${local_commit:0:7} â†’ æ–°: ${remote_commit:0:7}ï¼‰\033[0m"
                changes_detected=true

                if [ -d "../$name" ]; then
                  echo "   æ¸…ç†æ—§ç›®å½•: ../$name"
                  rm -rf "../$name"
                fi

                clone_dir="$name-temp"
                max_retries=3
                retry_count=0
                while [ $retry_count -lt $max_retries ]; do
                  if [ -n "$branch" ]; then
                    git clone -q --depth=1 -b "$branch" "$url" "$clone_dir"
                  else
                    git clone -q --depth=1 "$url" "$clone_dir"
                  fi
                  if [ $? -eq 0 ]; then
                    break
                  fi
                  retry_count=$((retry_count+1))
                  echo -e "\033[33mâš ï¸ å…‹éš†å¤±è´¥ï¼Œé‡è¯• $retry_count/$max_retries...\033[0m"
                  sleep 2
                  rm -rf "$clone_dir"
                done

                if [ $retry_count -eq $max_retries ]; then
                  echo -e "\033[31mâŒ å…‹éš† $name å¤±è´¥ï¼Œè·³è¿‡\033[0m"
                  exit 0
                fi

                if [[ -n "${subdirs[$name]}" ]]; then
                  subdir="${subdirs[$name]}"
                  echo "   æå–å­ç›®å½•: $subdir"
                  if [ -d "$clone_dir/$subdir" ]; then
                    mv "$clone_dir/$subdir" "${clone_dir}-content"
                    rm -rf "$clone_dir"
                    mv "${clone_dir}-content" "$clone_dir"
                  else
                    echo -e "\033[33mâš ï¸ å­ç›®å½• $subdir ä¸å­˜åœ¨ï¼Œè·³è¿‡æå–\033[0m"
                  fi
                fi

                rm -rf "$clone_dir/.git"
                mv "$clone_dir" "../$name"
                echo -e "\033[32mâœ… $name æ›´æ–°å®Œæˆ\033[0m"
              fi
              echo "$name $remote_commit" >> "../$TEMP_RECORD"
            ) || echo -e "\033[31mâš ï¸ $name å¤„ç†å¤±è´¥ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªä»“åº“\033[0m"
          done

          cd ..
          mv "$TEMP_RECORD" "$SYNC_RECORD"
          echo -e "\033[32mğŸ“¦ å·²æ›´æ–°åŒæ­¥è®°å½•å†…å®¹:\033[0m"
          cat "$SYNC_RECORD"
      - name: æ£€æµ‹æ”¹åŠ¨å¹¶æäº¤
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            time=$(date '+%Yå¹´%mæœˆ%dæ—¥ %Hæ—¶%Måˆ†%Sç§’')
            git add .
            git commit -m "ğŸˆåŒæ­¥æ—¶é—´ $timeğŸš€"
            git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
            git push origin ${{ matrix.branch }}
            echo -e "\033[32mâœ… å·²æäº¤å¹¶æ¨é€æ›´æ”¹\033[0m"
          else
            echo -e "\033[32mğŸŸ¢ æ— å˜åŒ–ï¼Œæ— éœ€æäº¤\033[0m"
          fi

  clean_runs:
    name: æ¸…ç†å†å²è¿è¡Œè®°å½•
    runs-on: ubuntu-latest
    needs: sync
    steps:
      - name: æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 0
          keep_minimum_runs: 0