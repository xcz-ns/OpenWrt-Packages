name: 每日同步上游仓库到 18.06

on:
  schedule:
    - cron: '0 4 * * *'  # UTC 4点，即北京时间12点
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: 检出当前仓库（18.06 分支）
        uses: actions/checkout@v4
        with:
          ref: 18.06
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: 配置 Git 用户信息
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: 读取上游同步记录
        id: read_record
        run: |
          if [ -f .sync-record ]; then
            echo "读取已有同步记录"
          else
            echo "未找到同步记录文件，创建空文件"
            touch .sync-record
          fi

      - name: 同步上游仓库（增量更新）
        run: |
          declare -A repos=(
            ["luci-app-argon-config"]="https://github.com/jerrykuku/luci-app-argon-config 18.06"
            ["luci-theme-argon"]="https://github.com/jerrykuku/luci-theme-argon 18.06"
            ["luci-theme-design"]="https://github.com/0x676e67/luci-theme-design"
            ["luci-app-design-config"]="https://github.com/0x676e67/luci-app-design-config"
            ["luci-theme-neobird"]="https://github.com/thinktip/luci-theme-neobird.git"
            ["luci-app-lucky"]="https://github.com/gdy666/luci-app-lucky.git"
            ["luci-app-filebrowser"]="https://github.com/xiaozhuai/luci-app-filebrowser 18.06"
            ["luci-app-GoWebDav"]="https://github.com/ToDesk/luci-app-GoWebDav.git"
            ["luci-app-poweroff"]="https://github.com/esirplayground/luci-app-poweroff"
            ["luci-app-store"]="https://github.com/db-one/dbone-packages 18.06"
          )

          # 读已有同步记录到关联数组 last_commits
          declare -A last_commits
          while read -r repo commit; do
            last_commits["$repo"]=$commit
          done < .sync-record

          # 临时目录，避免直接影响当前目录
          mkdir sync_temp
          cd sync_temp

          for name in "${!repos[@]}"; do
            entry=(${repos[$name]})
            url=${entry[0]}
            branch=${entry[1]:-}

            echo "处理仓库 $name，URL: $url，分支: ${branch:-默认分支}"

            # 获取远程最新提交
            if [ -n "$branch" ]; then
              remote_commit=$(git ls-remote "$url" refs/heads/"$branch" | awk '{print $1}')
            else
              remote_commit=$(git ls-remote "$url" HEAD | awk '{print $1}')
            fi

            if [ -z "$remote_commit" ]; then
              echo "无法获取远程仓库最新提交，跳过 $name"
              continue
            fi

            local_commit=${last_commits[$name]:-}

            if [ "$remote_commit" = "$local_commit" ]; then
              echo "$name 无变化，跳过更新"
              continue
            fi

            echo "$name 有更新，开始拉取"

            # 先删除旧目录（根目录下对应文件和目录）
            # 注意这里要小心不要误删.git 或 .sync-record 等关键文件
            # 你可以根据仓库结构调整排除规则，下面示范简单删除对应目录或文件
            if [ -d "../$name" ]; then
              rm -rf ../"$name"
            fi

            # 克隆代码到当前目录临时目录（单独一个目录）
            if [ -n "$branch" ]; then
              git clone --depth=1 -b "$branch" "$url" "$name-temp"
            else
              git clone --depth=1 "$url" "$name-temp"
            fi

            # 处理特殊目录结构
            if [[ "$name" == "luci-app-store" ]]; then
              # luci-app-store 在库里是子目录，搬出来
              mv "$name-temp/luci-app-store" "$name-temp-temp"
              rm -rf "$name-temp"
              mv "$name-temp-temp" "$name-temp"
            fi

            # 删除 .git 目录避免提交冲突
            rm -rf "$name-temp/.git"

            # 移动内容到根目录
            mv "$name-temp" ../"$name"

            # 记录新的提交哈希
            last_commits["$name"]=$remote_commit
          done

          cd ..

          # 更新 .sync-record 文件
          > .sync-record
          for repo in "${!last_commits[@]}"; do
            echo "$repo ${last_commits[$repo]}" >> .sync-record
          done

      - name: 检查变更并提交推送
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            time=$(date '+%Y年%m月%d日 %H时%M分%S秒')
            git add .
            git commit -m "更新时间：$time"
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            git push
          else
            echo "无变化，无需提交"
          fi

      - name: 清理历史 Workflow 运行记录
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 0
          keep_minimum_runs: 0
