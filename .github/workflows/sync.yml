name: è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸
run-name: è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ï¼ˆ${{ github.event_name }} - ${{ github.run_number }}ï¼‰

on:
  schedule:
    - cron: '0 4 * * *'  # UTC 4ç‚¹ï¼Œå³åŒ—äº¬æ—¶é—´12ç‚¹
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/sync.yml'

jobs:
  sync:
    name: åŒæ­¥åˆ° ${{ matrix.branch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: ['18.06', '24.10']
        include:
          - branch: '18.06'
            repos: |
              {
                "luci-app-argon-config": "https://github.com/jerrykuku/luci-app-argon-config 18.06",
                "luci-theme-argon": "https://github.com/jerrykuku/luci-theme-argon 18.06",
                "luci-theme-design": "https://github.com/0x676e67/luci-theme-design",
                "luci-app-design-config": "https://github.com/0x676e67/luci-app-design-config",
                "luci-theme-neobird": "https://github.com/thinktip/luci-theme-neobird",
                "luci-app-lucky": "https://github.com/gdy666/luci-app-lucky",
                "luci-app-filebrowser": "https://github.com/Lienol/openwrt-package",
                "luci-app-GoWebDav": "https://github.com/ToDesk/luci-app-GoWebDav",
                "luci-app-poweroff": "https://github.com/esirplayground/luci-app-poweroff",
                "luci-app-store": "https://github.com/db-one/dbone-packages 18.06",
                "luci-app-openclash": "https://github.com/vernesong/OpenClash",
                "luci-app-oaf": "https://github.com/db-one/dbone-packages 18.06",
                "luci-app-shutdown": "https://github.com/db-one/dbone-packages 18.06",
                "luci-lib-xterm": "https://github.com/db-one/dbone-packages 18.06",
                "taskd": "https://github.com/db-one/dbone-packages 18.06"
              }
            subdirs: |
              {
                "luci-app-lucky": "luci-app-lucky",
                "luci-app-store": "luci-app-store",
                "luci-app-openclash": "luci-app-openclash",
                "luci-app-filebrowser": "luci-app-filebrowser",
                "luci-lib-xterm": "luci-lib-xterm",
                "taskd": "taskd",
                "luci-app-shutdown": "luci-app-shutdown", 
                "luci-app-oaf": "luci-app-oaf"
              }
          - branch: '24.10'
            repos: |
              {
                "luci-app-argon-config": "https://github.com/jerrykuku/luci-app-argon-config",
                "luci-theme-argon": "https://github.com/jerrykuku/luci-theme-argon",
                "luci-theme-neobird": "https://github.com/thinktip/luci-theme-neobird",
                "luci-app-lucky": "https://github.com/gdy666/luci-app-lucky",
                "luci-app-filebrowser": "https://github.com/Lienol/openwrt-package",
                "luci-app-GoWebDav": "https://github.com/ToDesk/luci-app-GoWebDav",
                "luci-app-poweroff": "https://github.com/esirplayground/luci-app-poweroff",
                "luci-app-store": "https://github.com/db-one/dbone-packages 23.05",
                "luci-app-openclash": "https://github.com/vernesong/OpenClash",
                "luci-lib-taskd": "https://github.com/db-one/dbone-packages 23.05",
                "luci-lib-xterm": "https://github.com/db-one/dbone-packages 23.05",
                "taskd": "https://github.com/db-one/dbone-packages 23.05"
              }
            subdirs: |
              {
                "luci-app-lucky": "luci-app-lucky",
                "luci-app-store": "luci-app-store",
                "luci-app-openclash": "luci-app-openclash",
                "luci-app-filebrowser": "luci-app-filebrowser",
                "luci-lib-taskd": "luci-lib-taskd",
                "luci-lib-xterm": "luci-lib-xterm",
                "taskd": "taskd"
              }
    env:
      TZ: Asia/Shanghai
    steps:
      - name: æ£€å‡º ${{ matrix.branch }} åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: è®¾ç½® Git ç”¨æˆ·å
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: æ£€æŸ¥å¹¶å®‰è£… jq
        run: |
          if ! command -v jq &> /dev/null; then
            echo "jq æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
            sudo apt-get update
            sudo apt-get install -y jq
          else
            echo "jq å·²å®‰è£…"
          fi

      - name: åŠ è½½åŒæ­¥è®°å½•
        run: |
          SYNC_RECORD=".sync-record-${{ matrix.branch }}"
          if [ -f "$SYNC_RECORD" ]; then
            echo "è¯»å–å·²æœ‰åŒæ­¥è®°å½•: $SYNC_RECORD"
          else
            echo "æœªæ‰¾åˆ°åŒæ­¥è®°å½•æ–‡ä»¶ï¼Œåˆ›å»ºæ–°æ–‡ä»¶: $SYNC_RECORD"
            touch "$SYNC_RECORD"
          fi

      - name: å¢é‡åŒæ­¥ä»“åº“
        run: |
          # ä»çŸ©é˜µé…ç½®ä¸­è·å–JSONæ•°æ®
          REPOS_JSON='${{ matrix.repos }}'
          SUBDIRS_JSON='${{ matrix.subdirs }}'
          SYNC_RECORD=".sync-record-${{ matrix.branch }}"
          
          # è§£æJSONåˆ°å…³è”æ•°ç»„
          declare -A repos
          while IFS="=" read -r key value; do
            repos["$key"]="$value"
          done < <(jq -r 'to_entries | .[] | "\(.key)=\(.value)"' <<< "$REPOS_JSON")
          
          declare -A subdirs
          while IFS="=" read -r key value; do
            subdirs["$key"]="$value"
          done < <(jq -r 'to_entries | .[] | "\(.key)=\(.value)"' <<< "$SUBDIRS_JSON")
          
          # è¯»å–ä¸Šæ¬¡åŒæ­¥è®°å½•
          declare -A last_commits
          while read -r repo commit; do
            last_commits["$repo"]=$commit
          done < "$SYNC_RECORD"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p sync_temp
          cd sync_temp
          
          # åˆå§‹åŒ–å˜åŒ–æ£€æµ‹æ ‡å¿—
          changes_detected=false
          
          # éå†æ‰€æœ‰ä»“åº“
          for name in "${!repos[@]}"; do
            (
              echo "ğŸ” å¼€å§‹å¤„ç†ä»“åº“: $name"
              
              # è§£æä»“åº“URLå’Œåˆ†æ”¯
              entry="${repos[$name]}"
              url=$(echo "$entry" | awk '{print $1}')
              branch=$(echo "$entry" | awk '{print $2}')
              
              echo "   URL: $url"
              echo "   åˆ†æ”¯: ${branch:-é»˜è®¤åˆ†æ”¯}"
              
              # è·å–è¿œç¨‹æœ€æ–°æäº¤
              if [ -n "$branch" ]; then
                remote_commit=$(git ls-remote "$url" "refs/heads/$branch" | awk '{print $1}')
              else
                remote_commit=$(git ls-remote "$url" HEAD | awk '{print $1}')
              fi
              
              if [ -z "$remote_commit" ]; then
                echo "âŒ æ— æ³•è·å–è¿œç¨‹ä»“åº“æœ€æ–°æäº¤ï¼Œè·³è¿‡ $name"
                exit 0
              fi
              
              # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
              local_commit="${last_commits[$name]:-}"
              if [ "$remote_commit" == "$local_commit" ]; then
                echo "âœ… $name æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°"
                exit 0
              fi
              
              # æ ‡è®°æœ‰å˜åŒ–
              changes_detected=true
              
              echo "ğŸ”„ $name æœ‰æ›´æ–°ï¼ˆæ—§æäº¤: ${local_commit:0:7} â†’ æ–°æäº¤: ${remote_commit:0:7}ï¼‰"
              
              # æ¸…ç†æ—§ç›®å½•
              if [ -d "../$name" ]; then
                echo "   æ¸…ç†æ—§ç›®å½•: ../$name"
                rm -rf "../$name"
              fi
              
              # å…‹éš†ä»“åº“ï¼ˆå¸¦é‡è¯•ï¼‰
              clone_dir="$name-temp"
              max_retries=3
              retry_count=0
              
              while [ $retry_count -lt $max_retries ]; do
                if [ -n "$branch" ]; then
                  git clone -q --depth=1 -b "$branch" "$url" "$clone_dir"
                else
                  git clone -q --depth=1 "$url" "$clone_dir"
                fi
                
                if [ $? -eq 0 ]; then
                  break
                fi
                
                retry_count=$((retry_count+1))
                echo "âš ï¸ å…‹éš†å¤±è´¥ï¼Œé‡è¯• $retry_count/$max_retries..."
                sleep 2
                rm -rf "$clone_dir"
              done
              
              if [ $retry_count -eq $max_retries ]; then
                echo "âŒ å…‹éš† $name å¤±è´¥ï¼Œè·³è¿‡"
                exit 0
              fi
              
              # å¤„ç†å­ç›®å½•
              if [[ -n "${subdirs[$name]}" ]]; then
                subdir="${subdirs[$name]}"
                echo "   æå–å­ç›®å½•: $subdir"
                
                if [ -d "$clone_dir/$subdir" ]; then
                  mv "$clone_dir/$subdir" "${clone_dir}-content"
                  rm -rf "$clone_dir"
                  mv "${clone_dir}-content" "$clone_dir"
                else
                  echo "âš ï¸ å­ç›®å½• $subdir ä¸å­˜åœ¨ï¼Œè·³è¿‡æå–"
                fi
              fi
              
              # æ¸…ç†.gitç›®å½•å¹¶ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
              rm -rf "$clone_dir/.git"
              mv "$clone_dir" "../$name"
              
              # æ›´æ–°åŒæ­¥è®°å½•
              last_commits["$name"]=$remote_commit
              echo "âœ… $name æ›´æ–°æˆåŠŸ"
            ) || echo "âš ï¸ $name å¤„ç†è¿‡ç¨‹ä¸­å‡ºé”™ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªä»“åº“"
          done
          
          cd ..
          
          # ä¿å­˜åŒæ­¥è®°å½•ï¼ˆåªæœ‰å½“æœ‰å˜åŒ–æ—¶æ‰æ›´æ–°ï¼‰
          if [ "$changes_detected" = true ]; then
            echo "ğŸ”„ æ£€æµ‹åˆ°å˜åŒ–ï¼Œæ›´æ–°åŒæ­¥è®°å½•æ–‡ä»¶: $SYNC_RECORD"
            > "$SYNC_RECORD"
            for repo in "${!last_commits[@]}"; do
              echo "$repo ${last_commits[$repo]}" >> "$SYNC_RECORD"
            done
            echo "æ›´æ–°åçš„åŒæ­¥è®°å½•å†…å®¹:"
            cat "$SYNC_RECORD"
          else
            echo "ğŸŸ¢ æ— å˜åŒ–ï¼Œä¿æŒåŒæ­¥è®°å½•ä¸å˜"
          fi

      - name: æ£€æµ‹æ”¹åŠ¨å¹¶æäº¤
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            time=$(date '+%Yå¹´%mæœˆ%dæ—¥ %Hæ—¶%Måˆ†%Sç§’')
            git add .
            git commit -m "chore(${{ matrix.branch }}): è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ [$time]"
            git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
            git push origin ${{ matrix.branch }}
            echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ”¹"
          else
            echo "ğŸŸ¢ æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          fi

  clean_runs:
    name: æ¸…ç†å†å²è¿è¡Œè®°å½•
    runs-on: ubuntu-latest
    needs: sync
    steps:
      - name: æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 0
          keep_minimum_runs: 0